<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人生おかね診断 - あなたの未来の家計を診断</title>
    <meta name="description" content="簡単な質問に答えるだけで、生涯にわたる収支と資産推移をシミュレーション。老後資金計画に役立つアドバイスも提供します。">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- SVGアイコンライブラリ -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;" aria-hidden="true">
        <symbol id="icon-info" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-chart-placeholder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3v18h18"/>
            <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
        </symbol>
        <symbol id="icon-advice-placeholder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.73 18.23H2.27a.9.9 0 01-.79-1.38L11.21 3.3a.9.9 0 011.58 0l9.73 13.55a.9.9 0 01-.79 1.38zM12 9v4M12 17h.01"/>
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </symbol>
        <symbol id="icon-edit" viewBox="0 0 20 20" fill="currentColor">
          <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-check" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-warning" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-calculator" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm6 7a1 1 0 112 0v3a1 1 0 11-2 0v-3zm-3 3a1 1 0 100 2h.01a1 1 0 100-2H10zm-4 1a1 1 0 011-1h.01a1 1 0 110 2H7a1 1 0 01-1-1zm1-4a1 1 0 100 2h.01a1 1 0 100-2H7zm2 1a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm4-4a1 1 0 100 2h.01a1 1 0 100-2H13zM9 9a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zM7 8a1 1 0 000 2h.01a1 1 0 000-2H7z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-arrow-right" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
        </symbol>
        <symbol id="icon-arrow-left" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </symbol>
    </svg>

    <div id="quickGuideOverlay" class="quick-guide-overlay" style="display:none;">
        <div class="quick-guide-content">
            <p>まずここを押して基本情報を入力しよう</p>
            <span class="quick-guide-arrow">⬇️</span>
            <button type="button" class="btn btn--primary" onclick="closeQuickGuide()">スタート</button>
        </div>
    </div>


    <div class="container">
        <!-- ヘッダーセクション -->
        <header class="header" role="banner">
            <div class="header-content">
                <h1 class="header-title">
                    <span class="header-icon" aria-hidden="true">💰</span>
                    人生おかね診断
                </h1>
                <p class="header-subtitle">
                    簡単な質問に答えるだけで、あなたの未来の家計を詳しく診断します
                </p>
                <div class="header-benefits">
                    <div class="benefit-item">
                        <span class="benefit-icon" aria-hidden="true">📊</span>
                        <span>詳細な資産推移グラフ</span>
                    </div>
                    <div class="benefit-item">
                        <span class="benefit-icon" aria-hidden="true">💡</span>
                        <span>個別アドバイス付き</span>
                    </div>
                    <div class="benefit-item">
                        <span class="benefit-icon" aria-hidden="true">🔒</span>
                        <span>データは端末内で安全に処理</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- ===== クイック診断セクション (ここから追加) ===== -->
        <section id="quickDiagnostics" class="quick-diagnostics-section card" aria-labelledby="quick-diagnostics-title">
            <header class="quick-diagnostics-header">
                <h2 id="quick-diagnostics-title" class="quick-diagnostics-title">
                    <span class="quick-diagnostics-icon" aria-hidden="true">⏱️</span>
                    まずは30秒！クイック診断
                </h2>
                <p class="quick-diagnostics-description">
                    3つの項目を入力するだけで、あなたの未来の家計をざっくり診断します。
                </p>
            </header>
        
            <div id="quickDiagnosticsForm" class="quick-diagnostics-form">
                <div class="quick-diagnostics-grid">
                    <div class="form-group">
                        <label class="form-label required" for="quickAge">現在の年齢</label>
                        <div class="input-wrapper">
                            <input type="number" class="form-control" id="quickAge" placeholder="35" min="18" max="80">
                            <span class="input-unit">歳</span>
                        </div>
                        <div id="quickAgeError" class="input-error-message" style="display:none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="quickIncome">月の手取り収入</label>
                        <div class="input-wrapper">
                            <input type="number" class="form-control" id="quickIncome" placeholder="30.0" min="5" step="0.1">
                            <span class="input-unit">万円</span>
                        </div>
                        <div id="quickIncomeError" class="input-error-message" style="display:none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="quickOccupation">現在の主な職業</label>
                        <select class="form-control" id="quickOccupation">
                            <option value="">-- 職業を選択してください --</option>
                            <option value="employee">会社員（厚生年金加入）</option>
                            <option value="civil_servant">公務員（共済年金）</option>
                            <option value="self_employed">自営業・フリーランス（国民年金のみ）</option>
                            <option value="part_time">パート・アルバイト</option>
                            <option value="other">その他・無職</option>
                        </select>
                        <div id="quickOccupationError" class="input-error-message" style="display:none;"></div>
                    </div>
                </div>
                <div class="quick-diagnostics-actions">
                    <button id="quickDiagnosticsButton" class="btn btn--primary btn--large">クイック診断スタート！</button>
                </div>
            </div>
        
            <div id="quickDiagnosticsResult" class="quick-diagnostics-result" style="display:none;">
                <h3 class="result-title">クイック診断結果</h3>
                <p id="quickResultText" class="result-text"></p>
                <p id="quickResultAdvice" class="result-advice"></p>
                <button id="startDetailedDiagnosticsButton" class="btn btn--secondary">もっと詳しく診断する（無料）</button>
            </div>
        </section>
        <!-- ===== (ここまで追加) ===== -->

        <!-- 大きなステップ表示 -->
        <nav class="main-step-tracker" aria-label="ステップ概要">
            <div class="main-step active" data-phase="1" aria-current="step">はじめに</div>
            <div class="main-step" data-phase="2">入力</div>
            <div class="main-step" data-phase="3">結果</div>
        </nav>

        <!-- プログレスセクション -->
        <section class="progress-section" aria-label="進捗状況">
            <div class="progress-container">
                <div class="progress-header">
                    <h2 class="progress-title">入力の進捗</h2>
                    <div class="progress-summary" id="progressSummary" aria-live="polite">
                        ステップ 1 / 5 を入力中
                    </div>
                </div>
                
                <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="20" aria-describedby="progressDescription">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-percentage" id="progressPercentage">20%</div>
                </div>
                
                <div class="progress-steps" id="progressSteps">
                    <button class="step-label active" data-step="1" type="button" aria-current="step">
                        <span class="step-number">1</span>
                        <span class="step-text">基本情報</span>
                    </button>
                    <button class="step-label" data-step="2" type="button">
                        <span class="step-number">2</span>
                        <span class="step-text">固定費</span>
                    </button>
                    <button class="step-label" data-step="3" type="button">
                        <span class="step-number">3</span>
                        <span class="step-text">ライフイベント</span>
                    </button>
                    <button class="step-label" data-step="4" type="button">
                        <span class="step-number">4</span>
                        <span class="step-text">詳細設定</span>
                    </button>
                    <button class="step-label" data-step="5" type="button">
                        <span class="step-number">5</span>
                        <span class="step-text">結果</span>
                    </button>
                </div>
                
                <p id="progressDescription" class="progress-description">
                    全5ステップで完了します。各ステップで必要な情報を入力してください。
                </p>
            </div>
        </section>

        <!-- ローディングアニメーション -->
        <div class="loading" id="loadingAnimation" aria-live="polite" aria-hidden="true">
            <div class="loading-content">
                <div class="spinner" aria-hidden="true"></div>
                <h3 class="loading-title">計算中...</h3>
                <p class="loading-subtitle">あなたの生涯収支を詳しく分析しています</p>
                <div class="loading-steps">
                    <div class="loading-step active">年金額を計算中</div>
                    <div class="loading-step">ライフイベント費用を算出中</div>
                    <div class="loading-step">資産推移を予測中</div>
                    <div class="loading-step">アドバイスを生成中</div>
                </div>
            </div>
        </div>

        <!-- ステップ1: 基本情報 -->
        <section class="step-section active" id="step1" aria-labelledby="step1-title">
            <div class="card">
                <header class="step-header">
                    <h2 id="step1-title" class="step-title">
                        <span class="step-icon" aria-hidden="true">📋</span>
                        基本情報を入力してください
                    </h2>
                    <p class="step-description">
                        年金額やシミュレーション期間を計算するために必要な基本情報を入力します
                    </p>
                </header>

                <!-- 価値観診断セクション -->
                <section class="personality-section" aria-labelledby="personality-title">
                    <header class="personality-header">
                        <h3 id="personality-title" class="personality-title">
                            <span class="personality-icon" aria-hidden="true">💭</span>
                            あなたの価値観診断
                        </h3>
                        <p class="personality-description">
                            より良いアドバイスを提供するため、まずはあなたの価値観をお聞かせください
                        </p>
                    </header>
                    
                    <div class="personality-question">
                        <h4 class="question-text">あなたにとって、お金を使う上で最も大切なことは何ですか？</h4>
                        
                        <div class="personality-options" role="radiogroup" aria-labelledby="personality-title">
                            <label class="personality-option">
                                <input type="radio" name="financialPersonality" value="security" class="personality-radio" aria-describedby="security-desc">
                                <div class="option-content">
                                    <div class="option-icon">🛡️</div>
                                    <div class="option-text">
                                        <div class="option-title">将来のための着実な貯蓄と安定</div>
                                        <div class="option-description" id="security-desc">リスクを避け、確実に資産を積み上げたい</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="personality-option">
                                <input type="radio" name="financialPersonality" value="growth" class="personality-radio" aria-describedby="growth-desc">
                                <div class="option-content">
                                    <div class="option-icon">📈</div>
                                    <div class="option-text">
                                        <div class="option-title">スキルアップやキャリアのための自己投資</div>
                                        <div class="option-description" id="growth-desc">将来の収入増を目指して自分に投資したい</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="personality-option">
                                <input type="radio" name="financialPersonality" value="freedom" class="personality-radio" aria-describedby="freedom-desc">
                                <div class="option-content">
                                    <div class="option-icon">✨</div>
                                    <div class="option-text">
                                        <div class="option-title">旅行や趣味など、今を楽しむための体験</div>
                                        <div class="option-description" id="freedom-desc">人生は一度きり、今の楽しみを大切にしたい</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="personality-option">
                                <input type="radio" name="financialPersonality" value="contribution" class="personality-radio" aria-describedby="contribution-desc">
                                <div class="option-content">
                                    <div class="option-icon">❤️</div>
                                    <div class="option-text">
                                        <div class="option-title">家族との時間や大切な人への贈り物</div>
                                        <div class="option-description" id="contribution-desc">大切な人との関係を深めることを重視したい</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div id="financialPersonalityError" class="input-error-message" role="alert" style="display:none;"></div>
                    </div>
                </section>
                
                <div class="form-section">
                    <fieldset class="form-fieldset">
                        <legend class="fieldset-legend">個人情報</legend>
                        
                        <div class="form-group">
                            <label class="form-label required" for="birthYear">
                                <span class="label-text">生年月日</span>
                                <button type="button" class="tooltip-trigger" aria-describedby="tooltip-birthdate">
                                    <svg class="tooltip-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    <span class="sr-only">ヘルプを表示</span>
                                </button>
                            </label>
                            <div class="tooltip-content" id="tooltip-birthdate" role="tooltip">
                                年金計算やシミュレーション期間の算出に必要です。正確な年月を入力してください。
                            </div>
                            
                            <div class="birthday-input">
                                <div class="input-wrapper">
                                    <select class="form-control" id="birthYear" required aria-describedby="birthdate-help">
                                        <option value="">年を選択</option>
                                    </select>
                                    <label class="input-label" for="birthYear">年</label>
                                </div>
                                <div class="input-wrapper">
                                    <select class="form-control" id="birthMonth" required aria-describedby="birthdate-help">
                                        <option value="">月を選択</option>
                                    </select>
                                    <label class="input-label" for="birthMonth">月</label>
                                </div>
                            </div>
                            
                            <div id="birthdate-help" class="input-help">
                                例：1985年3月生まれの場合は「1985年」「3月」を選択
                            </div>
                            <div id="birthDateError" class="input-error-message" role="alert" style="display:none;"></div>
                            
                            <div class="age-display" id="ageDisplay" style="display: none;" aria-live="polite">
                                <div class="age-display-content">
                                    <span class="age-display-icon" aria-hidden="true">🎂</span>
                                    <span class="age-display-text">現在の年齢: <strong id="currentAge">--</strong>歳</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required" for="income">
                                <span class="label-text">月の手取り収入</span>
                                <button type="button" class="tooltip-trigger" aria-describedby="tooltip-income">
                                    <svg class="tooltip-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    <span class="sr-only">ヘルプを表示</span>
                                </button>
                            </label>
                            <div class="tooltip-content" id="tooltip-income" role="tooltip">
                                税金・社会保険料を差し引いた、毎月実際に受け取る金額を入力してください。ボーナスは含めず、月平均で計算してください。
                            </div>
                            
                            <div class="input-wrapper">
                                <input type="number" class="form-control" id="income" 
                                       placeholder="30.0" min="5" max="300" step="0.1" required
                                       aria-describedby="income-help income-unit">
                                <span class="input-unit" id="income-unit">万円</span>
                            </div>
                            
                            <div id="income-help" class="input-help">
                                <strong>入力例：</strong>額面40万円で手取り32万円の場合 → 「32.0」と入力
                            </div>
                            <div id="incomeError" class="input-error-message" role="alert" style="display:none;"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required" for="occupation">
                                <span class="label-text">現在の主な職業</span>
                                <button type="button" class="tooltip-trigger" aria-describedby="tooltip-occupation">
                                    <svg class="tooltip-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    <span class="sr-only">ヘルプを表示</span>
                                </button>
                            </label>
                            <div class="tooltip-content" id="tooltip-occupation" role="tooltip">
                                現在の状況、または今後のキャリアで主となるものを選択してください。厚生年金の加入予定に影響します。
                            </div>
                            
                            <select class="form-control" id="occupation" required aria-describedby="occupation-help">
                                <option value="">-- 職業を選択してください --</option>
                                <option value="employee">会社員（厚生年金加入）</option>
                                <option value="civil_servant">公務員（共済年金）</option>
                                <option value="self_employed">自営業・フリーランス（国民年金のみ）</option>
                                <option value="part_time">パート・アルバイト</option>
                                <option value="other">その他・無職</option>
                            </select>
                            
                            <div id="occupation-help" class="input-help">
                                転職予定がある場合は、将来長く続ける予定の職業を選択してください
                            </div>
                            <div id="occupationError" class="input-error-message" role="alert" style="display:none;"></div>
                        </div>
                    </fieldset>

                    <fieldset class="form-fieldset">
                        <legend class="fieldset-legend">年金加入期間</legend>
                        <div class="fieldset-description">
                            将来の年金額を計算するため、これまでの加入実績と今後の加入予定を入力してください
                        </div>
                        
                        <div class="pension-input-group">
                            <!-- 国民年金セクション -->
                            <div class="pension-input-item">
                                <header class="pension-header">
                                    <h4 class="pension-title">
                                        <span class="pension-icon" aria-hidden="true">🏛️</span>
                                        国民年金
                                    </h4>
                                    <div class="pension-summary" id="nationalPensionSummary" aria-live="polite">
                                        合計: 0年 / 最大40年
                                    </div>
                                </header>
                                
                                <div class="pension-period-group">
                                    <div class="pension-period-type">
                                        <label class="form-label" for="nationalPension実績Years">
                                            <span class="label-text">これまでの加入実績</span>
                                            <span class="label-annotation">（20歳〜現在）</span>
                                        </label>
                                        
                                        <div class="pension-slider-container">
                                            <input type="range" class="pension-slider" id="nationalPension実績Slider" 
                                                   min="0" max="40" value="0" step="1" 
                                                   aria-describedby="nationalPension実績Help">
                                            
                                            <div class="pension-value-display">
                                                <span class="range-min" id="nationalPension実績SliderMinLabel">0年</span>
                                                <div class="pension-years-input-wrapper">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="nationalPension実績Years" data-step="-1" 
                                                            aria-label="実績年数を1年減らす">
                                                        <span aria-hidden="true">−</span>
                                                    </button>
                                                    <input type="number" class="pension-years-input" id="nationalPension実績Years" 
                                                           min="0" max="40" value="0" required 
                                                           aria-describedby="nationalPension実績Help">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="nationalPension実績Years" data-step="1" 
                                                            aria-label="実績年数を1年増やす">
                                                        <span aria-hidden="true">＋</span>
                                                    </button>
                                                    <span class="input-unit">年</span>
                                                </div>
                                                <span class="range-max" id="nationalPension実績SliderMaxLabel">40年</span>
                                            </div>
                                        </div>
                                        
                                        <div id="nationalPension実績Help" class="input-help">
                                            学生時代や転職の空白期間は除いてください
                                        </div>
                                        <div id="nationalPension実績YearsError" class="input-error-message" role="alert" style="display:none;"></div>
                                    </div>

                                    <div class="pension-period-type">
                                        <label class="form-label" for="nationalPension予定Years">
                                            <span class="label-text">これからの加入予定</span>
                                            <span class="label-annotation">（現在〜60歳）</span>
                                        </label>
                                        
                                        <div class="pension-slider-container">
                                            <input type="range" class="pension-slider" id="nationalPension予定Slider" 
                                                   min="0" max="40" value="20" step="1" 
                                                   aria-describedby="nationalPension予定Help">
                                            
                                            <div class="pension-value-display">
                                                <span class="range-min" id="nationalPension予定SliderMinLabel">0年</span>
                                                <div class="pension-years-input-wrapper">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="nationalPension予定Years" data-step="-1" 
                                                            aria-label="予定年数を1年減らす">
                                                        <span aria-hidden="true">−</span>
                                                    </button>
                                                    <input type="number" class="pension-years-input" id="nationalPension予定Years" 
                                                           min="0" max="40" value="20" required 
                                                           aria-describedby="nationalPension予定Help">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="nationalPension予定Years" data-step="1" 
                                                            aria-label="予定年数を1年増やす">
                                                        <span aria-hidden="true">＋</span>
                                                    </button>
                                                    <span class="input-unit">年</span>
                                                </div>
                                                <span class="range-max" id="nationalPension予定SliderMaxLabel">40年</span>
                                            </div>
                                        </div>
                                        
                                        <div id="nationalPension予定Help" class="input-help">
                                            今後フリーランスになる予定がある場合は調整してください
                                        </div>
                                        <div id="nationalPension予定YearsError" class="input-error-message" role="alert" style="display:none;"></div>
                                    </div>
                                </div>
                                
                                <div id="nationalPensionTotalError" class="input-error-message" role="alert" style="display:none;"></div>
                                <div id="nationalPensionGuidance" class="pension-guidance-message" aria-live="polite" style="display:none;"></div>
                                
                                <div class="pension-note">
                                    <svg class="note-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    国民年金は20歳から60歳まで加入義務があり、最大40年間です
                                </div>
                            </div>

                            <!-- 厚生年金セクション -->
                            <div class="pension-input-item" id="employeePensionItem">
                                <header class="pension-header">
                                    <h4 class="pension-title">
                                        <span class="pension-icon" aria-hidden="true">🏢</span>
                                        厚生年金
                                    </h4>
                                    <div class="pension-summary" id="employeePensionSummary" aria-live="polite">
                                        合計: 0年 / 最大52年
                                    </div>
                                </header>
                                
                                <div class="pension-period-group">
                                    <div class="pension-period-type">
                                        <label class="form-label" for="employeePension実績Years">
                                            <span class="label-text">これまでの加入実績</span>
                                            <span class="label-annotation">（18歳〜現在）</span>
                                        </label>
                                        
                                        <div class="pension-slider-container">
                                            <input type="range" class="pension-slider" id="employeePension実績Slider" 
                                                   min="0" max="50" value="0" step="1" 
                                                   aria-describedby="employeePension実績Help">
                                            
                                            <div class="pension-value-display">
                                                <span class="range-min" id="employeePension実績SliderMinLabel">0年</span>
                                                <div class="pension-years-input-wrapper">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="employeePension実績Years" data-step="-1" 
                                                            aria-label="実績年数を1年減らす">
                                                        <span aria-hidden="true">−</span>
                                                    </button>
                                                    <input type="number" class="pension-years-input" id="employeePension実績Years" 
                                                           min="0" max="50" value="0" 
                                                           aria-describedby="employeePension実績Help">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="employeePension実績Years" data-step="1" 
                                                            aria-label="実績年数を1年増やす">
                                                        <span aria-hidden="true">＋</span>
                                                    </button>
                                                    <span class="input-unit">年</span>
                                                </div>
                                                <span class="range-max" id="employeePension実績SliderMaxLabel">50年</span>
                                            </div>
                                        </div>
                                        
                                        <div id="employeePension実績Help" class="input-help">
                                            会社員・公務員として働いた期間を入力してください
                                        </div>
                                        <div id="employeePension実績YearsError" class="input-error-message" role="alert" style="display:none;"></div>
                                    </div>

                                    <div class="pension-period-type">
                                        <label class="form-label" for="employeePension予定Years">
                                            <span class="label-text">これからの加入予定</span>
                                            <span class="label-annotation">（現在〜退職予定）</span>
                                        </label>
                                        
                                        <div class="pension-slider-container">
                                            <input type="range" class="pension-slider" id="employeePension予定Slider" 
                                                   min="0" max="50" value="20" step="1" 
                                                   aria-describedby="employeePension予定Help">
                                            
                                            <div class="pension-value-display">
                                                <span class="range-min" id="employeePension予定SliderMinLabel">0年</span>
                                                <div class="pension-years-input-wrapper">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="employeePension予定Years" data-step="-1" 
                                                            aria-label="予定年数を1年減らす">
                                                        <span aria-hidden="true">−</span>
                                                    </button>
                                                    <input type="number" class="pension-years-input" id="employeePension予定Years" 
                                                           min="0" max="50" value="20" 
                                                           aria-describedby="employeePension予定Help">
                                                    <button type="button" class="pension-years-stepper" 
                                                            data-target="employeePension予定Years" data-step="1" 
                                                            aria-label="予定年数を1年増やす">
                                                        <span aria-hidden="true">＋</span>
                                                    </button>
                                                    <span class="input-unit">年</span>
                                                </div>
                                                <span class="range-max" id="employeePension予定SliderMaxLabel">50年</span>
                                            </div>
                                        </div>
                                        
                                        <div id="employeePension予定Help" class="input-help">
                                            今後自営業になる予定がある場合は0年に設定してください
                                        </div>
                                        <div id="employeePension予定YearsError" class="input-error-message" role="alert" style="display:none;"></div>
                                    </div>
                                </div>
                                
                                <div id="employeePensionTotalError" class="input-error-message" role="alert" style="display:none;"></div>
                                <div id="employeePensionGuidance" class="pension-guidance-message" aria-live="polite" style="display:none;"></div>
                                
                                <div class="pension-note">
                                    <svg class="note-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    厚生年金は70歳まで加入可能で、加入期間が長いほど年金額が増えます
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <!-- 年金概算表示 -->
                <div class="results-preview" id="pensionEstimate" style="display: none;" aria-live="polite">
                    <header class="results-preview-header">
                        <h3 class="results-preview-title">
                            <span class="results-icon" aria-hidden="true">📊</span>
                            将来の年金月額（概算）
                        </h3>
                        <p class="results-preview-subtitle">
                            入力内容に基づく概算額です。実際の年金額とは異なる場合があります
                        </p>
                    </header>
                    
                    <div class="results-preview-grid">
                        <div class="result-preview-item">
                            <div class="result-preview-value" id="nationalPensionAmount">0円</div>
                            <div class="result-preview-label">国民年金（月額）</div>
                        </div>
                        <div class="result-preview-item">
                            <div class="result-preview-value" id="employeePensionAmount">0円</div>
                            <div class="result-preview-label">厚生年金（月額）</div>
                        </div>
                        <div class="result-preview-item highlight">
                            <div class="result-preview-value" id="totalPensionAmount">0円</div>
                            <div class="result-preview-label">年金合計（月額）</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <nav class="step-navigation" aria-label="ステップナビゲーション">
                <div class="step-buttons">
                    <button class="btn btn--primary btn--large" onclick="nextStep()">
                        <span>次へ：固定費入力</span>
                        <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-arrow-right"></use></svg>
                    </button>
                </div>
                <div class="step-info">
                    <span class="step-counter">1 / 5</span>
                    <span class="step-time">約3分で完了</span>
                </div>
            </nav>
        </section>

        <!-- ステップ2: 固定費 -->
        <section class="step-section" id="step2" aria-labelledby="step2-title">
            <div class="card">
                <header class="step-header">
                    <h2 id="step2-title" class="step-title">
                        <span class="step-icon" aria-hidden="true">💳</span>
                        固定費を入力してください
                    </h2>
                    <p class="step-description">
                        毎月必ず支払っている費用を入力してください。支払いのない項目は空欄のままで構いません
                    </p>
                </header>

                <div class="form-section">
                    <div class="form-instructions">
                        <div class="instruction-item">
                            <span class="instruction-icon" aria-hidden="true">💡</span>
                            <span>金額は万円単位で入力してください（例：8万円の場合は「8.0」）</span>
                        </div>
                        <div class="instruction-item">
                            <span class="instruction-icon" aria-hidden="true">📝</span>
                            <span>支払いのない項目は空欄にするか0を入力してください</span>
                        </div>
                    </div>
                    
                    <div class="fixed-costs-grid" id="fixedCostsGrid" role="group" aria-labelledby="fixed-costs-legend">
                        <h3 id="fixed-costs-legend" class="sr-only">固定費の入力</h3>
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
                
                <!-- 固定費サマリー -->
                <div class="results-preview" aria-live="polite">
                    <header class="results-preview-header">
                        <h3 class="results-preview-title">
                            <span class="results-icon" aria-hidden="true">📊</span>
                            固定費の合計
                        </h3>
                    </header>
                    
                    <div class="results-preview-grid">
                        <div class="result-preview-item">
                            <div class="result-preview-value" id="totalFixedCosts">0.0万円</div>
                            <div class="result-preview-label">月額合計</div>
                        </div>
                        <div class="result-preview-item">
                            <div class="result-preview-value" id="fixedCostsRatio">0%</div>
                            <div class="result-preview-label">収入に対する比率</div>
                        </div>
                    </div>
                    
                    <div class="ratio-advice" id="ratioAdvice" aria-live="polite">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>
            
            <nav class="step-navigation" aria-label="ステップナビゲーション">
                <div class="step-buttons">
                    <button class="btn btn--secondary" onclick="prevStep()">
                        <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-arrow-left"></use></svg>
                        <span>戻る</span>
                    </button>
                    <button class="btn btn--primary btn--large" onclick="nextStep()">
                        <span>次へ：ライフイベント</span>
                        <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-arrow-right"></use></svg>
                    </button>
                </div>
                <div class="step-info">
                    <span class="step-counter">2 / 5</span>
                    <span class="step-time">残り約5分</span>
                </div>
            </nav>
        </section>

        <!-- ステップ3: ライフイベント -->
        <section class="step-section" id="step3" aria-labelledby="step3-title">
            <div class="card">
                <header class="step-header">
                    <h2 id="step3-title" class="step-title">
                        <span class="step-icon" aria-hidden="true">🎯</span>
                        ライフイベントを選択してください
                    </h2>
                    <p class="step-description">
                        将来予定している、または考慮したいライフイベントを選択してください
                    </p>
                </header>

                <div class="form-section">
                    <div class="life-events-grid" id="lifeEventsGrid" role="group" aria-labelledby="life-events-legend">
                        <h3 id="life-events-legend" class="sr-only">ライフイベントの選択</h3>
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                    
                    <!-- ライフイベント詳細設定 -->
                    <div id="lifeEventSpecificSettingsContainer" class="event-details-section">
                        <header class="section-header">
                            <h3 class="section-title">詳細設定</h3>
                            <p class="section-description">選択したライフイベントの詳細を設定してください</p>
                        </header>
                        
                        <div class="event-details-grid">
                            <div class="form-group" id="childrenCountGroup" style="display: none;" data-event-key="children">
                                <label class="form-label" for="childrenCount">
                                    <span class="label-text">子どもの予定人数</span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control" id="childrenCount" 
                                           min="0" max="10" value="1" required aria-describedby="childrenCount-help">
                                    <span class="input-unit">人</span>
                                </div>
                                <div id="childrenCount-help" class="input-help">
                                    0人の場合は子育て関連費用は計上されません
                                </div>
                                <div id="childrenCountError" class="input-error-message" role="alert" style="display:none;"></div>
                            </div>
                            
                            <div class="form-group" id="housingAgeGroup" style="display: none;" data-event-key="housing">
                                <label class="form-label" for="housingAge">
                                    <span class="label-text">住宅購入予定年齢</span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control" id="housingAge" 
                                           min="20" max="70" value="35" required aria-describedby="housingAge-help">
                                    <span class="input-unit">歳</span>
                                </div>
                                <div id="housingAge-help" class="input-help">
                                    現在年齢より若い年齢は設定できません
                                </div>
                                <div id="housingAgeError" class="input-error-message" role="alert" style="display:none;"></div>
                            </div>
                            
                            <div class="form-group" id="nisaAmountGroup" style="display: none;" data-event-key="nisa">
                                <label class="form-label" for="nisaAmount">
                                    <span class="label-text">つみたてNISAなどの月額積立額</span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="number" class="form-control" id="nisaAmount" 
                                           min="0.1" max="30" value="3.3" step="0.1" required aria-describedby="nisaAmount-help">
                                    <span class="input-unit">万円</span>
                                </div>
                                <div id="nisaAmount-help" class="input-help">
                                    <strong>参考：</strong>新NISA年間投資上限360万円（月額30万円相当）
                                </div>
                                <div class="nisa-info">
                                    新NISAではつみたて投資枠120万円＋成長投資枠240万円の合計360万円が年間の投資上限です
                                </div>
                                <div id="nisaAmountError" class="input-error-message" role="alert" style="display:none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- カスタムライフイベント -->
                    <div class="custom-events-section">
                        <header class="section-header">
                            <h3 class="section-title">
                                <span class="section-icon" aria-hidden="true">💰</span>
                                その他の大きな支出
                            </h3>
                            <p class="section-description">
                                上記以外に予定している大きな一時支出があれば追加してください
                            </p>
                        </header>
                        
                        <div class="custom-events-examples">
                            <div class="example-item">海外留学：200万円</div>
                            <div class="example-item">住宅リフォーム：300万円</div>
                            <div class="example-item">起業資金：500万円</div>
                        </div>
                        
                        <div class="custom-events-list">
                            <div class="custom-events-placeholder" id="customEventsPlaceholder">
                                <span class="placeholder-icon" aria-hidden="true">📝</span>
                                <span>大きな支出はまだ登録されていません</span>
                            </div>
                            <div id="customLifeEventsList">
                                <!-- JavaScriptで動的に生成 -->
                            </div>
                        </div>
                        
                        <!-- カスタムイベント入力フォーム -->
                        <div id="customEventFormContainer" class="custom-event-form" style="display: none;">
                            <header class="form-header">
                                <h4 id="customEventFormTitle" class="form-title">支出の追加</h4>
                            </header>
                            
                            <input type="hidden" id="customEventId">
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label required" for="customEventName">
                                        <span class="label-text">支出の名称</span>
                                    </label>
                                    <input type="text" class="form-control" id="customEventName" 
                                           placeholder="例：海外留学費用" required aria-describedby="customEventName-help">
                                    <div id="customEventName-help" class="input-help">
                                        具体的で分かりやすい名称を入力してください
                                    </div>
                                    <div id="customEventNameError" class="input-error-message" role="alert" style="display:none;"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label required" for="customEventAmount">
                                        <span class="label-text">金額</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" class="form-control" id="customEventAmount" 
                                               placeholder="200" min="1" step="1" required aria-describedby="customEventAmount-help">
                                        <span class="input-unit">万円</span>
                                    </div>
                                    <div id="customEventAmount-help" class="input-help">
                                        万円単位で入力してください（例：200万円の場合は「200」）
                                    </div>
                                    <div id="customEventAmountError" class="input-error-message" role="alert" style="display:none;"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label required" for="customEventAge">
                                        <span class="label-text">発生する年齢</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" class="form-control" id="customEventAge" 
                                               placeholder="30" min="18" max="100" required aria-describedby="customEventAge-help">
                                        <span class="input-unit">歳</span>
                                    </div>
                                    <div id="customEventAge-help" class="input-help">
                                        支出が発生する予定の年齢を入力してください
                                    </div>
                                    <div id="customEventAgeError" class="input-error-message" role="alert" style="display:none;"></div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn--secondary" id="cancelCustomEventButton">
                                    キャンセル
                                </button>
                                <button type="button" class="btn btn--primary" id="saveCustomEventButton">
                                    <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-check"></use></svg>
                                    <span>支出を保存</span>
                                </button>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn--outline btn--add" id="addCustomEventButton">
                            <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-plus"></use></svg>
                            <span>大きな支出を追加</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <nav class="step-navigation" aria-label="ステップナビゲーション">
                <div class="step-buttons">
                    <button class="btn btn--secondary" onclick="prevStep()">
                        <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-arrow-left"></use></svg>
                        <span>戻る</span>
                    </button>
                    <button class="btn btn--primary btn--large" onclick="nextStep()">
                        <span>次へ：詳細設定</span>
                        <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-arrow-right"></use></svg>
                    </button>
                </div>
                <div class="step-info">
                    <span class="step-counter">3 / 5</span>
                    <span class="step-time">残り約3分</span>
                </div>
            </nav>
        </section>

        <!-- ステップ4: 詳細設定 -->
        <section class="step-section" id="step4" aria-labelledby="step4-title">
            <div class="card">
                <header class="step-header">
                    <h2 id="step4-title" class="step-title">
                        <span class="step-icon" aria-hidden="true">⚙️</span>
                        詳細設定（オプション）
                    </h2>
                    <p class="step-description">
                        より詳細なシミュレーションのための設定です。デフォルト値でも十分な計算が可能です
                    </p>
                </header>

                <div class="form-section">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label class="form-label" for="retirementAge">
                                <span class="label-text">リタイア希望年齢</span>
                                <button type="button" class="tooltip-trigger" aria-describedby="tooltip-retirement">
                                    <svg class="tooltip-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    <span class="sr-only">ヘルプを表示</span>
                                </button>
                            </label>
                            <div class="tooltip-content" id="tooltip-retirement" role="tooltip">
                                働くことをやめる予定の年齢です。早期リタイアや定年延長を考慮して設定してください。65歳が一般的です。
                            </div>
                            
                            <div class="input-wrapper">
                                <input type="number" class="form-control" id="retirementAge" 
                                       min="55" max="75" value="65" required aria-describedby="retirementAge-help">
                                <span class="input-unit">歳</span>
                            </div>
                            <div id="retirementAge-help" class="input-help">
                                一般的な定年は65歳です。早期リタイアは慎重に検討してください
                            </div>
                            <div id="retirementAgeError" class="input-error-message" role="alert" style="display:none;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="expectedLifeExpectancy">
                                <span class="label-text">想定寿命</span>
                                <button type="button" class="tooltip-trigger" aria-describedby="tooltip-life">
                                    <svg class="tooltip-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    <span class="sr-only">ヘルプを表示</span>
                                </button>
                            </label>
                            <div class="tooltip-content" id="tooltip-life" role="tooltip">
                                シミュレーションを行う最終年齢です。長めに設定することで、より保守的で安全な資金計画を立てられます。
                            </div>
                            
                            <div class="input-wrapper">
                                <input type="number" class="form-control" id="expectedLifeExpectancy" 
                                       min="80" max="100" value="95" required aria-describedby="expectedLifeExpectancy-help">
                                <span class="input-unit">歳</span>
                            </div>
                            <div id="expectedLifeExpectancy-help" class="input-help">
                                日本人の平均寿命は男性81歳、女性87歳です（2023年）
                            </div>
                            <div id="expectedLifeExpectancyError" class="input-error-message" role="alert" style="display:none;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="investmentReturnRate">
                                <span class="label-text">NISA等 期待運用利回り</span>
                                <button type="button" class="tooltip-trigger" aria-describedby="tooltip-investrate">
                                    <svg class="tooltip-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                                    <span class="sr-only">ヘルプを表示</span>
                                </button>
                            </label>
                            <div class="tooltip-content" id="tooltip-investrate" role="tooltip">
                                NISAなどで投資を行う場合の年平均リターン率です。過去20年の全世界株式の平均は約5-7%ですが、保守的に3-4%で設定することを推奨します。
                            </div>
                            
                            <div class="input-wrapper">
                                <input type="number" class="form-control" id="investmentReturnRate" 
                                       min="0" max="15" value="3" step="0.1" required aria-describedby="investmentReturnRate-help">
                                <span class="input-unit">% / 年</span>
                            </div>
                            <div id="investmentReturnRate-help" class="input-help">
                                <strong>推奨値：</strong>保守的 3%、バランス型 5%、積極的 7%
                            </div>
                            <div id="investmentReturnRateError" class="input-error-message" role="alert" style="display:none;"></div>
                        </div>
                    </div>
                    
                    <div class="settings-note">
                        <div class="note-content">
                            <svg class="note-icon" aria-hidden="true"><use xlink:href="#icon-info"></use></svg>
                            <div class="note-text">
                                <strong>注意：</strong>これらの設定値は将来の不確実性を含んでいます。
                                定期的に見直しを行い、実際の状況に応じて調整することをお勧めします。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <nav class="step-navigation" aria-label="ステップナビゲーション">
                <div class="step-buttons">
                    <button class="btn btn--secondary" onclick="prevStep()">
                        <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-arrow-left"></use></svg>
                        <span>戻る</span>
                    </button>
                    <button class="btn btn--primary btn--large btn--calculate" onclick="calculateResults()">
                        <svg class="btn-icon" aria-hidden="true"><use xlink:href="#icon-calculator"></use></svg>
                        <span>結果を計算</span>
                    </button>
                </div>
                <div class="step-info">
                    <span class="step-counter">4 / 5</span>
                    <span class="step-time">計算まであと少し</span>
                </div>
            </nav>
        </section>

        <!-- ステップ5: 結果 -->
        <section class="step-section" id="step5" aria-labelledby="step5-title">
            <div class="card">
                <header class="step-header">
                    <h2 id="step5-title" class="step-title">
                        <span class="step-icon" aria-hidden="true">📊</span>
                        生涯収支シミュレーション結果
                    </h2>
                    <p class="step-description">
                        入力いただいた情報に基づいて、あなたの生涯収支を詳しく分析しました
                    </p>
                </header>

                <div class="results-section">
                    <!-- メイン結果表示 -->
                    <div class="results-hero" aria-live="polite">
                        <div class="rating-display" id="ratingDisplay">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                        <div class="results-main-summary" id="resultsMainSummary">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>

                    <!-- 結果サマリーカード -->
                    <div class="results-summary-section">
                        <h3 class="summary-section-title">主要な数値</h3>
                        <div class="results-summary-grid" id="resultsSummaryCards" aria-live="polite">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>
                    
                    <!-- 資産推移チャート -->
                    <div class="chart-section">
                        <header class="chart-header">
                            <h3 class="chart-title">年代別資産推移</h3>
                            <p class="chart-subtitle">あなたの年齢に応じた資産の変化を確認できます</p>
                        </header>
                        
                        <div class="chart-wrapper">
                            <div id="chartPlaceholder" class="chart-placeholder">
                                <svg class="placeholder-icon" aria-hidden="true"><use xlink:href="#icon-chart-placeholder"></use></svg>
                                <div class="placeholder-content">
                                    <h4>グラフを準備中...</h4>
                                    <p>シミュレーション結果を計算すると、ここに詳細なグラフが表示されます</p>
                                </div>
                            </div>
                            <canvas id="lifetimeChart" style="display: none;" aria-label="年代別資産推移グラフ"></canvas>
                        </div>
                        
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color total-assets"></div>
                                <span>総資産（現金＋投資）</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color cash-balance"></div>
                                <span>現金残高</span>
                            </div>
                            <div class="legend-item nisa-legend" style="display: none;">
                                <div class="legend-color nisa-balance"></div>
                                <span>NISA評価額</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- アドバイスセクション -->
                    <div class="advice-section" aria-live="polite">
                        <header class="advice-header">
                            <h3 class="advice-title">
                                <span class="advice-icon" aria-hidden="true">💡</span>
                                パーソナライズされたアドバイス
                            </h3>
                            <p class="advice-subtitle">
                                あなたの状況に合わせた具体的な改善提案をご覧ください
                            </p>
                        </header>
                        
                        <div id="advicePlaceholder" class="advice-placeholder">
                            <svg class="placeholder-icon" aria-hidden="true"><use xlink:href="#icon-advice-placeholder"></use></svg>
                            <div class="placeholder-content">
                                <h4>アドバイスを準備中...</h4>
                                <p>シミュレーション結果に基づいた具体的なアドバイスがここに表示されます</p>
                            </div>
                        </div>
                        
                        <div class="advice-content" id="adviceContent" style="display: none;">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <nav class="step-navigation" aria-label="アクションメニュー">
                <div class="step-buttons">
                    <button class="btn btn--outline" onclick="resetApp()">
                        <span>もう一度やり直す</span>
                    </button>
                    <button class="btn btn--secondary" onclick="saveSettings()">
                        <span>設定を保存する</span>
                    </button>
                    <button class="btn btn--success" onclick="scrollToAdvice()">
                        <span>アドバイスを見る</span>
                    </button>
                    <button class="btn btn--primary" onclick="exportResults()">
                        <span>結果をダウンロード</span>
                    </button>
                    <button class="btn btn--secondary" onclick="downloadChartImage()">
                        <span>グラフを画像保存</span>
                    </button>
                    <button class="btn btn--secondary" onclick="shareResults()">
                        <span>SNSで共有</span>
                    </button>
                </div>
                <div class="step-info completed">
                    <span class="step-counter">完了</span>
                    <span class="step-time">お疲れさまでした</span>
                </div>
            </nav>
        </section>
    </div>

    <!-- フッター -->
    <footer class="footer" role="contentinfo">
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title">ご利用にあたって</h3>
                <ul class="footer-list">
                    <li>このシミュレーションは一般的な情報提供を目的としています</li>
                    <li>結果は概算値であり、実際の収支と異なる場合があります</li>
                    <li>定期的な見直しと専門家への相談をお勧めします</li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3 class="footer-title">プライバシーについて</h3>
                <ul class="footer-list">
                    <li>入力されたデータはお使いの端末にのみ保存されます</li>
                    <li>外部サーバーへの送信は一切行いません</li>
                    <li>ブラウザを閉じても設定は保持されます</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2024 人生おかね診断. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
</body>
</html>
```

---
### `script.js` の変更

クイック診断のロジックを管理する `QuickDiagnosticsManager` オブジェクトを追加し、初期化時に呼び出すように変更します。

```javascript
--- START OF FILE script.js ---

/**
 * 人生おかね診断 - JavaScript
 * 100点のUI/UX体験を提供する高品質なシミュレーションアプリケーション
 */

// ===== アプリケーション設定 =====
const APP_CONFIG = {
    VERSION: '3.0.0',
    STORAGE_KEY: 'lifetimeSimulatorData_v3',
    DEBOUNCE_DELAY: 300,
    ANIMATION_DURATION: 300,
    NOTIFICATION_DURATION: 4000,
    CALCULATION_DELAY: 1500,
    MAX_RETRIES: 3
};

// ===== アプリケーションデータ =====
const APP_DATA = {
    categories: [
        { id: "housing", name: "住居費", icon: "🏠", placeholder: "8.0", max: 50, description: "家賃、住宅ローン、管理費、固定資産税など" },
        { id: "food", name: "食費", icon: "🍽️", placeholder: "6.0", max: 20, description: "外食費、食材費、お弁当代など" },
        { id: "utilities", name: "水道光熱費", icon: "⚡", placeholder: "2.0", max: 10, description: "電気、ガス、水道の基本料金+使用料" },
        { id: "communication", name: "通信費", icon: "📱", placeholder: "1.0", max: 5, description: "携帯電話、インターネット、固定電話など" },
        { id: "insurance", name: "保険料", icon: "🛡️", placeholder: "1.5", max: 10, description: "生命保険、医療保険、火災保険など" },
        { id: "vehicle", name: "自動車関連費", icon: "🚗", placeholder: "3.0", max: 10, description: "ローン、駐車場代、保険、車検、ガソリン代など" },
        { id: "education", name: "教育・自己投資費", icon: "📚", placeholder: "1.0", max: 20, description: "自身の学習、子供の習い事（学費本体除く）など" },
        { id: "subscriptions", name: "サブスクリプション", icon: "📺", placeholder: "0.3", max: 5, description: "動画・音楽配信、アプリなど" },
        { id: "others", name: "その他固定費", icon: "📦", placeholder: "1.0", max: 10, description: "こづかい、趣味、定期購入、ペット費用など" }
    ],
    lifeEvents: [
        { id: 1, key: "marriage", text: "結婚予定はありますか？", description: "平均費用：約300万円（一時費用）", icon: "💍", cost: 300, isOneTime: true },
        { id: 2, key: "car", text: "車の購入予定はありますか？", description: "購入費用：10年ごとに約200-300万円 + 維持費：月3-5万円程度", icon: "🚗", cost: 250, recurringCostPerYear: 48, isOneTime: false, costInterval: 10 },
        { id: 3, key: "children", text: "出産・子育て予定はありますか？", description: "子育て費用：1人あたり約1500-2000万円（大学卒業まで）", icon: "👶", cost: 1800, hasDetail: true, detailSettingKey: 'childrenCountGroup' },
        { id: 4, key: "housing", text: "住宅購入予定はありますか？", description: "住宅費用：約3000-5000万円 + 固定資産税等", icon: "🏠", cost: 3500, hasDetail: true, detailSettingKey: 'housingAgeGroup', isOneTime: true },
        { id: 5, key: "caregiving", text: "親の介護費用の準備は必要ですか？", description: "介護費用：一時金 約100万円、月額 約8万円程度", icon: "👴", cost: 100, recurringCostPerYear: 96, isOneTime: false },
        { id: 6, key: "travel", text: "海外旅行などの大きな娯楽費を考慮しますか？", description: "例: 5年ごとに100万円の大型旅行など", icon: "✈️", cost: 100, isOneTime: false, costInterval: 5 },
        { id: 7, key: "nisa", text: "つみたてNISAなどの投資を行いますか？", description: "月々の積立投資（結果は運用益として反映）", icon: "📈", hasDetail: true, investment: true, detailSettingKey: 'nisaAmountGroup' }
    ],
    defaultAdvancedSettings: {
        retirementAge: 65,
        expectedLifeExpectancy: 95,
        investmentReturnRate: 3.0,
    },
    personalityTypes: {
        security: {
            name: "安定重視型",
            description: "将来の安心と安定を最優先する",
            keywords: ["安心", "安定", "盤石", "確実", "堅実"]
        },
        growth: {
            name: "自己投資型",
            description: "スキルアップやキャリア形成への投資を重視する",
            keywords: ["成長", "スキルアップ", "キャリア", "向上", "発展"]
        },
        freedom: {
            name: "現在志向型",
            description: "今の楽しみや体験を大切にする",
            keywords: ["自由", "体験", "楽しみ", "今", "充実"]
        },
        contribution: {
            name: "貢献・家族型",
            description: "家族や大切な人との時間、社会貢献を重視する",
            keywords: ["家族", "貢献", "大切な人", "絆", "支え合い"]
        }
    }
};

// ===== アプリケーション状態 =====
class AppState {
    constructor() {
        this.currentStep = 1;
        this.farthestValidatedStep = 1;
        this.basicInfo = {
            birthday: null,
            income: null,
            occupation: '',
            nationalPension実績Years: 0,
            nationalPension予定Years: 20,
            employeePension実績Years: 0,
            employeePension予定Years: 20,
        };
        this.fixedCosts = {};
        this.lifeEvents = {};
        this.customLifeEvents = [];
        this.detailSettings = {
            childrenCount: 1,
            housingAge: 35,
            nisaAmount: 3.3
        };
        this.advancedSettings = { ...APP_DATA.defaultAdvancedSettings };
        this.results = {};
        this.validationErrors = new Map();
        this.isCalculating = false;
        this.financialPersonality = null;
    }
}

// ===== グローバル変数 =====
let appState = new AppState();
let lifetimeChart = null;
let debounceTimers = new Map();
let currentNotificationId = 0;

// ===== ユーティリティ関数 =====
const Utils = {
    debounce(key, func, delay = APP_CONFIG.DEBOUNCE_DELAY) {
        if (debounceTimers.has(key)) {
            clearTimeout(debounceTimers.get(key));
        }
        const timer = setTimeout(() => {
            func();
            debounceTimers.delete(key);
        }, delay);
        debounceTimers.set(key, timer);
    },
    getElement(id, required = true) {
        const element = document.getElementById(id);
        if (!element && required) {
            console.error(`Required element not found: ${id}`);
            return null;
        }
        return element;
    },
    parseNumber(value, defaultValue = 0, min = -Infinity, max = Infinity) {
        const num = parseFloat(value);
        if (isNaN(num)) return defaultValue;
        return Math.max(min, Math.min(max, num));
    },
    parseInt(value, defaultValue = 0, min = -Infinity, max = Infinity) {
        const num = parseInt(value, 10);
        if (isNaN(num)) return defaultValue;
        return Math.max(min, Math.min(max, num));
    },
    preciseAdd(a, b) {
        const factor = 100;
        return (Math.round(a * factor) + Math.round(b * factor)) / factor;
    },
    preciseMultiply(a, b) {
        const factor = 100;
        return (Math.round(a * factor) * b) / factor;
    },
    precisePercentage(value, total) {
        if (total === 0) return 0;
        return Math.round((value / total) * 1000) / 10;
    },
    calculateAge(birthDate) {
        if (!birthDate) return null;
        try {
            const today = new Date();
            const birth = new Date(birthDate);
            if (isNaN(birth.getTime())) return null;
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return Math.max(0, age);
        } catch (e) {
            return null;
        }
    },
    formatCurrency(amount, unit = '万円') {
        if (typeof amount !== 'number' || isNaN(amount)) return '---';
        if (Math.abs(amount) >= 10000) {
            return `${(amount / 10000).toFixed(1)}億${unit.replace('万', '')}`;
        }
        return `${Math.round(amount).toLocaleString()}${unit}`;
    },
    generateId() {
        return `_${Math.random().toString(36).substr(2, 9)}_${Date.now().toString(36)}`;
    },
    scrollToElement(element, offset = 0) {
        if (!element) return;
        const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
        window.scrollTo({
            top: elementPosition - offset,
            behavior: 'smooth'
        });
    },
    handleError(error, context = 'Unknown') {
        console.error(`Error in ${context}:`, error);
        NotificationManager.show('予期しないエラーが発生しました。', 'error');
    }
};

// ===== 通知管理システム =====
const NotificationManager = {
    show(message, type = 'info', duration = APP_CONFIG.NOTIFICATION_DURATION) {
        const existingNotification = document.querySelector('.notification');
        if(existingNotification) existingNotification.remove();

        const notification = document.createElement('div');
        notification.className = `notification notification--${type}`;
        notification.setAttribute('role', 'alert');

        const colors = { success: '#10b981', error: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
        const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };

        notification.innerHTML = `<span class="notification-icon">${icons[type]}</span> ${message}`;
        Object.assign(notification.style, {
            position: 'fixed', top: '20px', right: '20px', padding: '15px 20px', borderRadius: '8px',
            color: 'white', background: colors[type], zIndex: '10000', transform: 'translateX(120%)',
            opacity: '0', transition: 'all 0.4s ease', boxShadow: '0 4px 15px rgba(0,0,0,0.1)'
        });
        document.body.appendChild(notification);
        
        requestAnimationFrame(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        });

        setTimeout(() => {
            notification.style.transform = 'translateX(120%)';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 400);
        }, duration);
    }
};

// ===== ストレージ管理 =====
const StorageManager = {
    save(data) {
        try {
            const serializedData = JSON.stringify(data);
            localStorage.setItem(APP_CONFIG.STORAGE_KEY, serializedData);
        } catch (e) {
            console.error("Error saving to localStorage", e);
            NotificationManager.show("設定の保存に失敗しました。", "error");
        }
    },
    load() {
        try {
            const data = localStorage.getItem(APP_CONFIG.STORAGE_KEY);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error("Error loading from localStorage", e);
            localStorage.removeItem(APP_CONFIG.STORAGE_KEY);
            return null;
        }
    },
    clear() {
        localStorage.removeItem(APP_CONFIG.STORAGE_KEY);
    }
};

// ===== クイック診断管理システム =====
const QuickDiagnosticsManager = {
    init() {
        const button = Utils.getElement('quickDiagnosticsButton', false);
        const ctaButton = Utils.getElement('startDetailedDiagnosticsButton', false);

        if (button) {
            button.addEventListener('click', this.runDiagnostics.bind(this));
        }
        if (ctaButton) {
            ctaButton.addEventListener('click', this.startDetailedDiagnostics.bind(this));
        }
    },

    validateInputs(age, income, occupation) {
        let isValid = true;
        UIManager.clearError('quickAge');
        UIManager.clearError('quickIncome');
        UIManager.clearError('quickOccupation');

        if (!age || age < 18 || age > 80) {
            UIManager.showError('quickAge', '18歳から80歳までの年齢を入力してください。');
            isValid = false;
        }
        if (!income && income !== 0) {
            UIManager.showError('quickIncome', '有効な収入額を入力してください。');
            isValid = false;
        }
        if (!occupation) {
            UIManager.showError('quickOccupation', '職業を選択してください。');
            isValid = false;
        }
        return isValid;
    },

    calculate(age, income, occupation) {
        const PENSION_RETIREMENT_AGE = 65;
        const LIFE_EXPECTANCY = 95;
        
        let pension;
        switch (occupation) {
            case 'employee':
            case 'civil_servant':
                pension = 15; // 万円/月
                break;
            case 'self_employed':
            case 'part_time':
            case 'other':
            default:
                pension = 6.5; // 万円/月
                break;
        }
        
        const workingYears = Math.max(0, PENSION_RETIREMENT_AGE - age);
        const retiredYears = Math.max(0, LIFE_EXPECTANCY - PENSION_RETIREMENT_AGE);

        const totalWorkingIncome = workingYears * (income * 12);
        const totalPensionIncome = retiredYears * (pension * 12);
        const totalIncome = totalWorkingIncome + totalPensionIncome;

        const totalYears = Math.max(0, LIFE_EXPECTANCY - age);
        const totalExpenses = totalYears * (income * 0.7 * 12);
        
        const finalAssets = totalIncome - totalExpenses;

        return { finalAssets };
    },

    getAdvice(finalAssets) {
        if (finalAssets > 2000) {
            return '素晴らしいスタートです！詳細診断でさらに盤石な計画を立てましょう。';
        } else if (finalAssets >= 0) {
            return '同世代の平均的な水準です。詳細診断で改善点を見つけましょう。';
        } else if (finalAssets > -1000) {
            return '少し注意が必要かもしれません。詳細診断で家計の見直しポイントを探りましょう。';
        } else {
            return '将来の資金に不安が残ります。今すぐ詳細診断で対策を立てることを強くお勧めします。';
        }
    },

    runDiagnostics() {
        const age = Utils.parseInt(Utils.getElement('quickAge').value, null);
        const income = Utils.parseNumber(Utils.getElement('quickIncome').value, null);
        const occupation = Utils.getElement('quickOccupation').value;

        if (!this.validateInputs(age, income, occupation)) {
            NotificationManager.show('入力内容を確認してください', 'error');
            return;
        }

        const result = this.calculate(age, income, occupation);
        const advice = this.getAdvice(result.finalAssets);
        
        const resultTextEl = Utils.getElement('quickResultText');
        const resultAdviceEl = Utils.getElement('quickResultAdvice');
        const LIFE_EXPECTANCY = 95;
        
        resultTextEl.innerHTML = `あなたの${LIFE_EXPECTANCY}歳時点での推定資産は <strong>${Utils.formatCurrency(result.finalAssets)}</strong> です。`;
        resultAdviceEl.textContent = advice;

        Utils.getElement('quickDiagnosticsForm').style.display = 'none';
        Utils.getElement('quickDiagnosticsResult').style.display = 'block';
    },
    
    startDetailedDiagnostics() {
        const quickDiagnosticsSection = Utils.getElement('quickDiagnostics');
        const progressSection = Utils.getElement('progress-section');
        
        const age = Utils.parseInt(Utils.getElement('quickAge').value, null);
        const income = Utils.parseNumber(Utils.getElement('quickIncome').value, null);
        const occupation = Utils.getElement('quickOccupation').value;

        if (age && (income || income === 0) && occupation) {
            const birthYear = new Date().getFullYear() - age;
            const birthMonth = new Date().getMonth() + 1;
            Utils.getElement('birthYear').value = birthYear;
            Utils.getElement('birthMonth').value = birthMonth;
            appState.basicInfo.birthday = new Date(birthYear, birthMonth - 1, 1).toISOString().split('T')[0];
            FormManager.updateAgeDisplay();

            Utils.getElement('income').value = income;
            appState.basicInfo.income = income;
            Utils.getElement('occupation').value = occupation;
            appState.basicInfo.occupation = occupation;
            
            FormManager.autoSave();
        }

        quickDiagnosticsSection.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        quickDiagnosticsSection.style.opacity = '0';
        quickDiagnosticsSection.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            quickDiagnosticsSection.style.display = 'none';
            if (progressSection) {
                Utils.scrollToElement(progressSection, 20);
            }
        }, 500);
    }
};


// ===== UI管理システム =====
const UIManager = {
    updateProgress() {
        const percentage = appState.currentStep * 20;
        Utils.getElement('progressFill').style.width = `${percentage}%`;
        Utils.getElement('progressPercentage').textContent = `${percentage}%`;
        Utils.getElement('progressSummary').textContent = `ステップ ${appState.currentStep} / 5 を入力中`;
        this.updateStepLabels();
        this.updateMainSteps();
    },
    updateMainSteps() {
        const phaseMap = { 1: 1, 2: 2, 3: 2, 4: 2, 5: 3 };
        const currentPhase = phaseMap[appState.currentStep] || 1;
        document.querySelectorAll('.main-step').forEach((step, index) => {
            step.classList.toggle('active', index === currentPhase - 1);
        });
    },
    updateStepLabels() {
        document.querySelectorAll('.step-label').forEach(label => {
            const stepNum = Utils.parseInt(label.dataset.step);
            label.classList.remove('active', 'completed');
            label.disabled = stepNum > appState.farthestValidatedStep;
            if (stepNum === appState.currentStep) label.classList.add('active');
            else if (stepNum < appState.currentStep) label.classList.add('completed');
        });
    },
    showStep(stepNumber) {
        document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
        Utils.getElement(`step${stepNumber}`).classList.add('active');
        appState.currentStep = stepNumber;
        this.updateProgress();
    },
    showError(elementId, message) {
        const errorElement = Utils.getElement(`${elementId}Error`, false);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        const inputElement = Utils.getElement(elementId, false);
        if (inputElement) inputElement.classList.add('error');
    },
    clearError(elementId) {
        const errorElement = Utils.getElement(`${elementId}Error`, false);
        if (errorElement) errorElement.style.display = 'none';
        const inputElement = Utils.getElement(elementId, false);
        if (inputElement) inputElement.classList.remove('error');
    },
    showLoading() {
        Utils.getElement('loadingAnimation').classList.add('active');
    },
    hideLoading() {
        Utils.getElement('loadingAnimation').classList.remove('active');
    },
    updatePlaceholders(showResults = false) {
        Utils.getElement('chartPlaceholder').style.display = showResults ? 'none' : 'flex';
        Utils.getElement('lifetimeChart').style.display = showResults ? 'block' : 'none';
        Utils.getElement('advicePlaceholder').style.display = showResults ? 'none' : 'flex';
        Utils.getElement('adviceContent').style.display = showResults ? 'grid' : 'none';
    },
    showQuickGuide() {
        const overlay = Utils.getElement("quickGuideOverlay", false);
        if (overlay && !localStorage.getItem("guideShown")) {
            overlay.style.display = "flex";
        }
    },
    closeQuickGuide() {
        const overlay = Utils.getElement("quickGuideOverlay", false);
        if (overlay) overlay.style.display = "none";
        localStorage.setItem("guideShown", "1");
    }
};

// ===== フォーム管理システム =====
const FormManager = {
    setupBirthdaySelects() {
        const yearSelect = Utils.getElement('birthYear');
        const monthSelect = Utils.getElement('birthMonth');
        const currentYear = new Date().getFullYear();
        for (let y = currentYear - 18; y >= currentYear - 80; y--) yearSelect.add(new Option(`${y}年`, y));
        for (let m = 1; m <= 12; m++) monthSelect.add(new Option(`${m}月`, m));
        [yearSelect, monthSelect].forEach(el => el.addEventListener('change', () => this.updateAgeDisplay()));
    },
    updateAgeDisplay() {
        UIManager.clearError('birthDate');
        const year = Utils.getElement('birthYear').value;
        const month = Utils.getElement('birthMonth').value;
        const ageDisplay = Utils.getElement('ageDisplay');
        if (year && month) {
            const birthDate = new Date(year, month - 1, 1);
            const age = Utils.calculateAge(birthDate);
            if (age !== null) {
                Utils.getElement('currentAge').textContent = age;
                ageDisplay.style.display = 'block';
                appState.basicInfo.birthday = birthDate.toISOString().split('T')[0];
                PensionManager.adjustByAge(age);
            }
        } else {
            ageDisplay.style.display = 'none';
        }
        this.autoSave();
    },
    restoreFormData() {
        if (appState.financialPersonality) {
            const radio = document.querySelector(`input[name="financialPersonality"][value="${appState.financialPersonality}"]`);
            if (radio) radio.checked = true;
        }
        if (appState.basicInfo.birthday) {
            const d = new Date(appState.basicInfo.birthday);
            Utils.getElement('birthYear').value = d.getFullYear();
            Utils.getElement('birthMonth').value = d.getMonth() + 1;
            this.updateAgeDisplay();
        }
        Utils.getElement('income').value = appState.basicInfo.income;
        Utils.getElement('occupation').value = appState.basicInfo.occupation;
        
        Object.keys(appState.basicInfo).forEach(key => {
            if (key.includes('Pension')) {
                const el = Utils.getElement(key, false);
                if(el) el.value = appState.basicInfo[key];
                const slider = Utils.getElement(key.replace('Years', 'Slider'), false);
                if(slider) slider.value = appState.basicInfo[key];
            }
        });
        PensionManager.calculate();

        FixedCostManager.render();
        LifeEventManager.render();
        CustomEventManager.render();
        
        Object.keys(appState.advancedSettings).forEach(key => {
            const el = Utils.getElement(key, false);
            if (el) el.value = appState.advancedSettings[key];
        });

        Object.keys(appState.detailSettings).forEach(key => {
            const el = Utils.getElement(key, false);
            if (el) el.value = appState.detailSettings[key];
        });

        if (appState.results && appState.results.yearlyData && appState.results.yearlyData.length > 0) {
            UIManager.showStep(5);
            ResultsManager.render();
            UIManager.updatePlaceholders(true);
        }
    },
    autoSave() {
        Utils.debounce('autoSave', () => StorageManager.save(appState), 500);
    },
    saveCurrentStepData() {
        switch (appState.currentStep) {
            case 1: this.saveBasicInfo(); break;
            case 2: FixedCostManager.updateCosts(); break;
            case 3: this.saveLifeEvents(); break;
            case 4: this.saveAdvancedSettings(); break;
        }
        this.autoSave();
    },
    saveBasicInfo() {
        const personalityRadio = document.querySelector('input[name="financialPersonality"]:checked');
        appState.financialPersonality = personalityRadio ? personalityRadio.value : null;
        appState.basicInfo.income = Utils.parseNumber(Utils.getElement('income').value, null);
        appState.basicInfo.occupation = Utils.getElement('occupation').value;
    },
    saveLifeEvents() {
        if (appState.lifeEvents.children) appState.detailSettings.childrenCount = Utils.parseInt(Utils.getElement('childrenCount').value, 1);
        if (appState.lifeEvents.housing) appState.detailSettings.housingAge = Utils.parseInt(Utils.getElement('housingAge').value, 35);
        if (appState.lifeEvents.nisa) appState.detailSettings.nisaAmount = Utils.parseNumber(Utils.getElement('nisaAmount').value, 3.3);
    },
    saveAdvancedSettings() {
        appState.advancedSettings.retirementAge = Utils.parseInt(Utils.getElement('retirementAge').value, 65);
        appState.advancedSettings.expectedLifeExpectancy = Utils.parseInt(Utils.getElement('expectedLifeExpectancy').value, 95);
        appState.advancedSettings.investmentReturnRate = Utils.parseNumber(Utils.getElement('investmentReturnRate').value, 3.0);
    }
};

// ===== 年金管理システム =====
const PensionManager = {
    setupInputs() {
        const fields = ['nationalPension実績', 'nationalPension予定', 'employeePension実績', 'employeePension予定'];
        fields.forEach(field => {
            const slider = Utils.getElement(`${field}Slider`);
            const input = Utils.getElement(`${field}Years`);
            slider.addEventListener('input', () => { input.value = slider.value; this.handleInput(field, slider.value); });
            input.addEventListener('input', () => { slider.value = input.value; this.handleInput(field, input.value); });
        });
        document.querySelectorAll('.pension-years-stepper').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = e.currentTarget.dataset.target;
                const step = Utils.parseInt(e.currentTarget.dataset.step);
                const input = Utils.getElement(targetId);
                const newValue = Utils.parseInt(input.value) + step;
                if (newValue >= input.min && newValue <= input.max) {
                    input.value = newValue;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        });
    },
    handleInput(field, value) {
        appState.basicInfo[`${field}Years`] = Utils.parseInt(value);
        Utils.debounce('calculatePension', () => this.calculate(), 500);
        FormManager.autoSave();
    },
    adjustByAge(age) {
        const npFuture = Utils.getElement('nationalPension予定Years');
        const epFuture = Utils.getElement('employeePension予定Years');
        const retirementAge = appState.advancedSettings.retirementAge;

        npFuture.max = Math.max(0, 60 - age);
        npFuture.value = Math.min(Utils.parseInt(npFuture.value), npFuture.max);
        
        epFuture.max = Math.max(0, retirementAge - age);
        epFuture.value = Math.min(Utils.parseInt(epFuture.value), epFuture.max);
        
        this.calculate();
    },
    calculate() {
        const npYears = (appState.basicInfo.nationalPension実績Years || 0) + (appState.basicInfo.nationalPension予定Years || 0);
        const epYears = (appState.basicInfo.employeePension実績Years || 0) + (appState.basicInfo.employeePension予定Years || 0);
        const income = appState.basicInfo.income || 0;

        const npAmount = (816000 / 12) * (Math.min(npYears, 40) / 40);
        const avgReward = Math.min(Math.max(income * 1.35, 8.8), 65) * 10000;
        const epAmount = (epYears > 0 && income > 0) ? (avgReward * (5.481 / 1000) * (epYears * 12)) / 12 : 0;

        Utils.getElement('nationalPensionAmount').textContent = `${Math.round(npAmount).toLocaleString()}円`;
        Utils.getElement('employeePensionAmount').textContent = `${Math.round(epAmount).toLocaleString()}円`;
        Utils.getElement('totalPensionAmount').textContent = `${Math.round(npAmount + epAmount).toLocaleString()}円`;
        Utils.getElement('pensionEstimate').style.display = 'block';
        
        // ★★★ 修正点: 計算結果を返す ★★★
        return { npAmount, epAmount };
    }
};

// ===== 固定費管理システム =====
const FixedCostManager = {
    render() {
        const container = Utils.getElement('fixedCostsGrid');
        container.innerHTML = APP_DATA.categories.map(cat => this.createCostItem(cat)).join('');
        APP_DATA.categories.forEach(cat => {
            const input = Utils.getElement(`cost-${cat.id}`);
            input.value = appState.fixedCosts[cat.id]?.amount > 0 ? appState.fixedCosts[cat.id].amount : '';
            input.addEventListener('input', () => Utils.debounce('updateFixedCosts', () => this.updateCosts(), 300));
        });
        this.updateCosts();
    },
    createCostItem(category) {
        return `
            <div class="fixed-cost-item">
                <div class="cost-icon">${category.icon}</div>
                <div class="cost-details">
                    <label for="cost-${category.id}" class="cost-name">${category.name}</label>
                    <p class="cost-description">${category.description}</p>
                </div>
                <div class="input-wrapper">
                    <input type="number" class="cost-input form-control" id="cost-${category.id}" placeholder="${category.placeholder}" min="0" max="${category.max}" step="0.1" aria-label="${category.name}の月額">
                    <span class="input-unit">万円</span>
                </div>
            </div>`;
    },
    updateCosts() {
        let total = 0;
        APP_DATA.categories.forEach(cat => {
            const input = Utils.getElement(`cost-${cat.id}`);
            const amount = Utils.parseNumber(input.value, 0);
            appState.fixedCosts[cat.id] = { amount, isActive: amount > 0 };
            input.closest('.fixed-cost-item').classList.toggle('active', amount > 0);
            if (amount > 0) total = Utils.preciseAdd(total, amount);
        });

        Utils.getElement('totalFixedCosts').textContent = Utils.formatCurrency(total);
        const income = appState.basicInfo.income || 0;
        const ratio = income > 0 ? Utils.precisePercentage(total, income) : 0;
        Utils.getElement('fixedCostsRatio').textContent = `${ratio.toFixed(0)}%`;
        
        const adviceEl = Utils.getElement('ratioAdvice');
        if (ratio > 50) { adviceEl.textContent = '🚨 固定費比率が高すぎます！見直しを強く推奨します。'; adviceEl.className = 'ratio-advice advice-error';}
        else if (ratio > 40) { adviceEl.textContent = '🤔 固定費比率がやや高めです。見直しの余地がありそうです。'; adviceEl.className = 'ratio-advice advice-warning';}
        else { adviceEl.textContent = '✅ 理想的な固定費比率です！'; adviceEl.className = 'ratio-advice advice-good';}
    }
};

// ===== ライフイベント管理システム =====
const LifeEventManager = {
    render() {
        const container = Utils.getElement('lifeEventsGrid');
        container.innerHTML = APP_DATA.lifeEvents.map(event => this.createEventItem(event)).join('');
        container.querySelectorAll('.life-event-item').forEach(item => {
            item.addEventListener('click', () => this.toggleEvent(item.dataset.eventKey, item));
        });
        this.updateDetailSettingsVisibility();
    },
    createEventItem(event) {
        const selected = appState.lifeEvents[event.key];
        return `
            <div class="life-event-item ${selected ? 'selected' : ''}" data-event-key="${event.key}" role="button" tabindex="0">
                <div class="event-icon">${event.icon}</div>
                <div class="event-content">
                    <div class="event-text">${event.text}</div>
                    <div class="event-description">${event.description}</div>
                </div>
                <div class="toggle-switch ${selected ? 'active' : ''}"><div class="toggle-slider"></div></div>
            </div>`;
    },
    toggleEvent(key, item) {
        appState.lifeEvents[key] = !appState.lifeEvents[key];
        item.classList.toggle('selected');
        item.querySelector('.toggle-switch').classList.toggle('active');
        this.updateDetailSettingsVisibility();
        FormManager.autoSave();
    },
    updateDetailSettingsVisibility() {
        APP_DATA.lifeEvents.forEach(event => {
            if (event.hasDetail) {
                const group = Utils.getElement(event.detailSettingKey);
                group.style.display = appState.lifeEvents[event.key] ? 'block' : 'none';
            }
        });
    }
};

// ===== カスタムライフイベント管理システム =====
const CustomEventManager = {
    setup() {
        Utils.getElement('addCustomEventButton').addEventListener('click', () => this.showForm());
        Utils.getElement('cancelCustomEventButton').addEventListener('click', () => this.hideForm());
        Utils.getElement('saveCustomEventButton').addEventListener('click', () => this.saveEvent());
        Utils.getElement('customLifeEventsList').addEventListener('click', e => {
            const item = e.target.closest('.custom-event-item');
            if (!item) return;
            const id = item.dataset.id;
            if (e.target.closest('.edit-custom-event')) this.showForm(id);
            if (e.target.closest('.delete-custom-event')) this.deleteEvent(id);
        });
        this.render();
    },
    render() {
        const list = Utils.getElement('customLifeEventsList');
        const placeholder = Utils.getElement('customEventsPlaceholder');
        list.innerHTML = '';
        if (appState.customLifeEvents.length === 0) {
            placeholder.style.display = 'flex';
        } else {
            placeholder.style.display = 'none';
            appState.customLifeEvents.forEach(event => list.appendChild(this.createEventItem(event)));
        }
    },
    createEventItem(event) {
        const item = document.createElement('div');
        item.className = 'custom-event-item';
        item.dataset.id = event.id;
        item.innerHTML = `
            <div class="custom-event-details">
                <strong>${event.name}</strong>: ${Utils.formatCurrency(event.amount)} (${event.age}歳時)
            </div>
            <div class="custom-event-actions">
                <button type="button" class="btn btn--secondary edit-custom-event" aria-label="編集"><svg class="btn-icon"><use xlink:href="#icon-edit"></use></svg></button>
                <button type="button" class="btn btn--secondary delete-custom-event" aria-label="削除"><svg class="btn-icon"><use xlink:href="#icon-trash"></use></svg></button>
            </div>`;
        return item;
    },
    showForm(id = null) {
        this.resetForm();
        if (id) {
            const event = appState.customLifeEvents.find(e => e.id === id);
            Utils.getElement('customEventId').value = event.id;
            Utils.getElement('customEventName').value = event.name;
            Utils.getElement('customEventAmount').value = event.amount;
            Utils.getElement('customEventAge').value = event.age;
        }
        Utils.getElement('customEventFormContainer').style.display = 'block';
        Utils.getElement('addCustomEventButton').style.display = 'none';
    },
    hideForm() {
        Utils.getElement('customEventFormContainer').style.display = 'none';
        Utils.getElement('addCustomEventButton').style.display = 'inline-flex';
    },
    resetForm() {
        ['customEventId', 'customEventName', 'customEventAmount', 'customEventAge'].forEach(id => {
            Utils.getElement(id).value = '';
            UIManager.clearError(id);
        });
    },
    saveEvent() {
        const id = Utils.getElement('customEventId').value;
        const name = Utils.getElement('customEventName').value;
        const amount = Utils.parseNumber(Utils.getElement('customEventAmount').value);
        const age = Utils.parseInt(Utils.getElement('customEventAge').value);
        
        if (!name || amount <= 0 || age <= 0) {
            NotificationManager.show('すべての項目を正しく入力してください。', 'error');
            return;
        }

        if (id) {
            const index = appState.customLifeEvents.findIndex(e => e.id === id);
            appState.customLifeEvents[index] = { id, name, amount, age };
        } else {
            appState.customLifeEvents.push({ id: Utils.generateId(), name, amount, age });
        }
        this.render();
        this.hideForm();
        FormManager.autoSave();
    },
    deleteEvent(id) {
        if (confirm('この支出を削除しますか？')) {
            appState.customLifeEvents = appState.customLifeEvents.filter(e => e.id !== id);
            this.render();
            FormManager.autoSave();
        }
    }
};

// ===== バリデーション管理システム =====
const StepValidator = {
    validateStep(stepNumber) {
        let isValid = true;
        const clearAndSetError = (id, message) => {
            UIManager.clearError(id);
            UIManager.showError(id, message);
            isValid = false;
        };

        const stepContainer = document.querySelector(`#step${stepNumber}`);
        if (stepContainer) {
            stepContainer.querySelectorAll('.input-error-message').forEach(el => el.style.display = 'none');
            stepContainer.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
        }

        switch (stepNumber) {
            case 1:
                if (!appState.financialPersonality) clearAndSetError('financialPersonality', '価値観を選択してください。');
                if (!appState.basicInfo.birthday) clearAndSetError('birthDate', '生年月日を選択してください。');
                if (!appState.basicInfo.income) clearAndSetError('income', '手取り収入を入力してください。');
                if (!appState.basicInfo.occupation) clearAndSetError('occupation', '職業を選択してください。');
                break;
        }
        return isValid;
    }
};

// ===== ナビゲーション管理システム =====
const NavigationManager = {
    nextStep() {
        FormManager.saveCurrentStepData();
        if (!StepValidator.validateStep(appState.currentStep)) {
            NotificationManager.show('入力内容を確認してください', 'error');
            return;
        }
        if (appState.currentStep < 5) {
            appState.farthestValidatedStep = Math.max(appState.farthestValidatedStep, appState.currentStep + 1);
            UIManager.showStep(appState.currentStep + 1);
        }
    },
    previousStep() {
        if (appState.currentStep > 1) UIManager.showStep(appState.currentStep - 1);
    },
    goToStep(targetStep) {
        if (targetStep <= appState.farthestValidatedStep) UIManager.showStep(targetStep);
    }
};

// ===== 計算エンジン =====
const CalculationEngine = {
    async calculate() {
        FormManager.saveCurrentStepData();
        UIManager.showLoading();
        await new Promise(resolve => setTimeout(resolve, APP_CONFIG.CALCULATION_DELAY));

        try {
            const results = this.performCalculation();
            appState.results = results;
            UIManager.hideLoading();
            UIManager.showStep(5);
            ResultsManager.render();
            UIManager.updatePlaceholders(true);
            FormManager.autoSave();
        } catch (error) {
            UIManager.hideLoading();
            Utils.handleError(error, 'Calculation');
        }
    },
    performCalculation() {
        const currentAge = Utils.calculateAge(appState.basicInfo.birthday);
        const { retirementAge, expectedLifeExpectancy, investmentReturnRate } = appState.advancedSettings;
        const invRate = investmentReturnRate / 100;
        
        // ★★★ 修正点: PensionManager.calculate()から値を受け取る ★★★
        const pensionAmounts = PensionManager.calculate(); 
        const totalPensionAmount = (pensionAmounts.npAmount || 0) + (pensionAmounts.epAmount || 0);

        let cashBalance = 0, nisaBalance = 0, totalIncome = 0, totalExpenses = 0, nisaFinalContribution = 0;
        let yearlyData = [];

        for (let age = currentAge; age <= expectedLifeExpectancy; age++) {
            const isRetired = age >= retirementAge;
            const income = isRetired ? (totalPensionAmount * 12) : (appState.basicInfo.income * 12);
            
            let cashExpense = Object.values(appState.fixedCosts).reduce((sum, cost) => sum + (cost.amount * 12), 0);
            
            let eventCost = 0;
            appState.customLifeEvents.forEach(e => { if(e.age === age) eventCost += e.amount; });
            
            if (appState.lifeEvents.housing && age === appState.detailSettings.housingAge) {
                eventCost += APP_DATA.lifeEvents.find(e=>e.key==='housing').cost;
            }
            if(appState.lifeEvents.children && appState.detailSettings.childrenCount > 0) {
                 const firstChildAge = Math.max(currentAge + 2, 30);
                 for (let i = 0; i < appState.detailSettings.childrenCount; i++) {
                    const childBirthAge = firstChildAge + (i * 3);
                    const childsCurrentAge = age - childBirthAge;
                    if(childsCurrentAge >= 0 && childsCurrentAge < 22){
                        eventCost += (APP_DATA.lifeEvents.find(e=>e.key==='children').cost / appState.detailSettings.childrenCount) / 22;
                    }
                 }
            }
            cashExpense += eventCost;

            let nisaInvestment = 0;
            if (appState.lifeEvents.nisa && !isRetired) {
                nisaInvestment = appState.detailSettings.nisaAmount * 12;
                nisaFinalContribution += nisaInvestment;
            }
            
            nisaBalance = (nisaBalance + nisaInvestment) * (1 + invRate);
            const netCashFlow = income - cashExpense - nisaInvestment;
            cashBalance += netCashFlow;

            totalIncome += income;
            totalExpenses += cashExpense;

            yearlyData.push({ age, income, cashExpense, nisaInvestment, cumulativeCash: cashBalance, nisaBalance, totalAssets: cashBalance + nisaBalance });
        }
        
        const finalBalance = cashBalance + nisaBalance;
        const retirementData = yearlyData.find(d => d.age === retirementAge);

        return {
            totalIncome, totalExpenses, finalBalance,
            retirementAssets: retirementData ? retirementData.totalAssets : 0,
            nisaFinalContribution, nisaFinalBalance: nisaBalance,
            yearlyData,
            rating: this.calculateRating(finalBalance, totalIncome, expectedLifeExpectancy - currentAge)
        };
    },
    calculateRating(finalBalance, totalIncome, years) {
        if (years <= 0) return 'D';
        const avgAnnualIncome = totalIncome / years;
        if (finalBalance < -500) return 'D';
        if (finalBalance < 0) return 'C';
        if (finalBalance < (avgAnnualIncome * 2)) return 'B';
        if (finalBalance < (avgAnnualIncome * 5)) return 'A';
        return 'S';
    }
};

// ===== 結果管理システム =====
const ResultsManager = {
    render() {
        this.renderRatingAndSummary();
        this.renderSummaryCards();
        this.renderChart();
        this.renderAdvice();
    },
    renderRatingAndSummary() {
        const { rating, finalBalance } = appState.results;
        const ratingMap = {
            'S': { text: 'S', class: 'rating-s', msg: '素晴らしい！' }, 'A': { text: 'A', class: 'rating-a', msg: '良好です！' },
            'B': { text: 'B', class: 'rating-b', msg: 'まずまずです。' }, 'C': { text: 'C', class: 'rating-c', msg: '要注意。' },
            'D': { text: 'D', class: 'rating-d', msg: '危険水域。' }
        };
        const currentRating = ratingMap[rating];
        Utils.getElement('ratingDisplay').innerHTML = `<div class="rating-badge ${currentRating.class}">${currentRating.text}</div>`;
        Utils.getElement('resultsMainSummary').innerHTML = `最終的に <strong>${Utils.formatCurrency(finalBalance)}</strong> の資産が見込まれます。${currentRating.msg}`;
    },
    renderSummaryCards() {
        const container = Utils.getElement('resultsSummaryCards');
        const { totalIncome, totalExpenses, finalBalance, retirementAssets } = appState.results;
        const cards = [
            { icon: '💰', label: '生涯総収入', value: totalIncome, positive: true },
            { icon: '💸', label: '生涯総支出', value: totalExpenses, positive: false },
            { icon: '🏦', label: '最終資産', value: finalBalance, positive: finalBalance >= 0 },
            { icon: '👴', label: '退職時資産', value: retirementAssets, positive: retirementAssets >= 0 }
        ];
        container.innerHTML = cards.map(c => `
            <div class="result-card">
                <div class="result-icon">${c.icon}</div>
                <div class="result-label">${c.label}</div>
                <div class="result-value ${c.positive ? 'positive' : 'negative'}">${Utils.formatCurrency(c.value)}</div>
            </div>`).join('');
    },
    renderChart() {
        const ctx = Utils.getElement('lifetimeChart').getContext('2d');
        if (lifetimeChart) lifetimeChart.destroy();
        const { yearlyData } = appState.results;
        const labels = yearlyData.map(d => `${d.age}歳`);
        const datasets = [
            { label: '総資産', data: yearlyData.map(d => d.totalAssets), borderColor: 'rgba(37, 99, 235, 1)', backgroundColor: 'rgba(37, 99, 235, 0.2)', fill: true, tension: 0.3 },
            { label: '現金残高', data: yearlyData.map(d => d.cumulativeCash), borderColor: 'rgba(245, 158, 11, 1)', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: false, borderDash: [5, 5] },
        ];
        if (appState.lifeEvents.nisa) {
            datasets.push({ label: 'NISA評価額', data: yearlyData.map(d => d.nisaBalance), borderColor: 'rgba(16, 185, 129, 1)', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: false });
            Utils.getElement('lifetimeChart').closest('.chart-section').querySelector('.nisa-legend').style.display = 'flex';
        }
        lifetimeChart = new Chart(ctx, {
            type: 'line', data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    },
    renderAdvice() {
        const container = Utils.getElement('adviceContent');
        container.innerHTML = '';
        this._addAdvice(container, this.getOverallAdvice());
        if (Object.values(appState.fixedCosts).reduce((s, c) => s + c.amount, 0) > (appState.basicInfo.income * 0.5))
            this._addAdvice(container, { type: 'warning', msg: '<strong>固定費:</strong> 収入に対する固定費の割合が50%を超えています。家計の見直しを強く推奨します。' });
        if (!appState.lifeEvents.nisa)
            this._addAdvice(container, { type: 'info', msg: '<strong>投資:</strong> NISAなどの積立投資が計画に含まれていません。インフレ対策として少額からでも始めることを検討しましょう。' });
        this._addAdvice(container, this.getPersonalityAdvice());
    },
    _addAdvice(container, {type, msg}) {
        const item = document.createElement('div');
        item.className = `advice-item type-${type}`;
        item.innerHTML = `<div>${msg}</div>`;
        container.appendChild(item);
    },
    getOverallAdvice() {
        const { rating } = appState.results;
        const personality = appState.financialPersonality || 'security';
        const keywords = APP_DATA.personalityTypes[personality].keywords;
        const messages = {
            S: `<strong>総合評価 (S): 素晴らしい！</strong> あなたの理想とする「${keywords[0]}」のある未来が期待できます。盤石な計画です。`,
            A: `<strong>総合評価 (A): 良好です。</strong> あなたが大切にする「${keywords[0]}」を実現する土台はしっかり築かれています。この調子でいきましょう。`,
            B: `<strong>総合評価 (B): まずまずです。</strong> あなたの目標である「${keywords[0]}」のためには、もう少し工夫が必要です。改善の余地があります。`,
            C: `<strong>総合評価 (C): 注意が必要です。</strong> このままでは、あなたの望む「${keywords[0]}」を達成するのは難しいかもしれません。計画を見直しましょう。`,
            D: `<strong>総合評価 (D): 危険な状態です。</strong> 早急な対策が必要です。将来の「${keywords[0]}」が危ぶまれます。専門家への相談も検討してください。`
        };
        const type = rating >= 'C' ? 'good' : 'warning';
        return { type, msg: messages[rating] };
    },
    getPersonalityAdvice() {
        const personality = appState.financialPersonality || 'security';
        const messages = {
            security: `<strong>あなたへ (安定重視型):</strong> 将来の安心を確実にする素晴らしい計画です。リスクの低い個人向け国債やiDeCoの活用も検討し、さらなる安定を目指しましょう。`,
            growth: `<strong>あなたへ (自己投資型):</strong> スキルアップへの投資は、将来の収入増に繋がり、結果としてあなたの可能性を広げます。計画に「自己投資費」を具体的に組み込み、リターンを最大化しましょう。`,
            freedom: `<strong>あなたへ (現在志向型):</strong> 「今」を楽しむための経済基盤を築けています。「カスタムライフイベント」でやりたいことを具体的に計画し、人生をさらに豊かにしましょう。`,
            contribution: `<strong>あなたへ (貢献・家族型):</strong> 大切な人との時間を守るための計画ができています。家族や社会への想いを形にするため、生命保険や相続対策、寄付なども視野に入れてみましょう。`
        };
        return { type: 'info', msg: messages[personality] };
    }
};

// ===== グローバル関数 (イベントハンドラ) =====
function nextStep() { NavigationManager.nextStep(); }
function prevStep() { NavigationManager.previousStep(); }
function calculateResults() { CalculationEngine.calculate(); }
function resetApp() { if (confirm('入力をリセットしますか？')) { StorageManager.clear(); location.reload(); } }
function saveSettings() { FormManager.autoSave(); NotificationManager.show('設定を保存しました', 'success'); }
function scrollToAdvice() { Utils.scrollToElement(Utils.getElement('advice-section'), 80); }
function exportResults() { /* ...実装 ... */ }
function downloadChartImage() { if (lifetimeChart) { const a = document.createElement('a'); a.href = lifetimeChart.toBase64Image(); a.download = 'my-chart.png'; a.click(); } }
function shareResults() { /* ...実装 ... */ }
function closeQuickGuide() { UIManager.closeQuickGuide(); }

// ===== アプリケーション初期化 =====
const AppInitializer = {
    init() {
        this.loadData();
        this.setupUI();
        QuickDiagnosticsManager.init();
        this.setupEventListeners();
        UIManager.showQuickGuide();
    },
    loadData() {
        const saved = StorageManager.load();
        if (saved) {
            const defaultState = new AppState();
            appState = {
                ...defaultState,
                ...saved,
                basicInfo: { ...defaultState.basicInfo, ...saved.basicInfo },
                fixedCosts: { ...defaultState.fixedCosts, ...saved.fixedCosts },
                lifeEvents: { ...defaultState.lifeEvents, ...saved.lifeEvents },
                customLifeEvents: saved.customLifeEvents || [],
                detailSettings: { ...defaultState.detailSettings, ...saved.detailSettings },
                advancedSettings: { ...defaultState.advancedSettings, ...saved.advancedSettings },
            };
        }
    },
    setupUI() {
        FormManager.setupBirthdaySelects();
        PensionManager.setupInputs();
        CustomEventManager.setup();
        FormManager.restoreFormData();
        UIManager.showStep(appState.currentStep);
    },
    setupEventListeners() {
        document.querySelectorAll('.step-label').forEach(l => l.addEventListener('click', () => NavigationManager.goToStep(Utils.parseInt(l.dataset.step))));
        document.querySelectorAll('input[name="financialPersonality"]').forEach(r => r.addEventListener('change', e => {
            appState.financialPersonality = e.target.value;
            FormManager.autoSave();
            UIManager.clearError('financialPersonality');
        }));
        ['income', 'occupation', 'childrenCount', 'housingAge', 'nisaAmount', 'retirementAge', 'expectedLifeExpectancy', 'investmentReturnRate']
            .forEach(id => {
                const el = Utils.getElement(id, false);
                if (el) el.addEventListener('input', () => FormManager.saveCurrentStepData());
            });
    }
};

document.addEventListener('DOMContentLoaded', () => {
    try {
        AppInitializer.init();
    } catch (e) {
        console.error("Fatal Error:", e);
        document.body.innerHTML = '<h1>アプリケーションの起動に失敗しました。ページを再読み込みしてください。</h1>';
    }
});
